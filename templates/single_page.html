<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal</title>
    
    <!-- FullCalendar -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet'>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial; }
        body { background: #0f0f0f; color: white; padding: 20px; max-width: 1400px; margin: 0 auto; }
        
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #333; }
        .header h1 { color: #FFC107; font-size: 2.5em; margin-bottom: 10px; }
        
        .section {
            background: #1a1a1a;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 12px;
            border: 1px solid #333;
        }
        
        .section-title {
            color: #FFC107;
            font-size: 1.4em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .period-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .period-btn {
            flex: 1;
            padding: 10px;
            background: #2a2a2a;
            border: 2px solid #333;
            color: #888;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .period-btn.active {
            background: #FFC107;
            border-color: #FFC107;
            color: black;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #FFC107;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .metric-value.negative {
            color: #f44336;
        }
        
        .metric-label {
            color: #888;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        #calendar {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .fc-toolbar-title { color: #FFC107 !important; }
        .fc-col-header-cell { background: #2a2a2a !important; color: #FFC107 !important; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        th {
            background: #2a2a2a;
            color: #FFC107;
            padding: 12px;
            text-align: left;
            font-size: 0.9em;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #333;
        }
        
        .win { color: #4CAF50; font-weight: bold; }
        .loss { color: #f44336; font-weight: bold; }
        
        .btn {
            background: #FFC107;
            color: black;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 2px;
        }
        
        .btn:hover { background: #ffb300; }
        .btn-small { padding: 5px 10px; font-size: 0.9em; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            color: #888;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .filter-group select {
            width: 100%;
            padding: 8px;
            background: #2a2a2a;
            border: 1px solid #444;
            color: white;
            border-radius: 6px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            border: 2px solid #FFC107;
        }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #888; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            background: #2a2a2a;
            border: 1px solid #444;
            color: white;
            border-radius: 6px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1>üìä Trading Journal</h1>
        <p style="color: #888;">Complete trading system</p>
    </div>
    
    <!-- PERIOD FILTERS -->
    <div class="section">
        <div class="section-title">üìà Performance Metrics</div>
        <div class="period-filters">
            <button class="period-btn active" onclick="changePeriod('all')">All Time</button>
            <button class="period-btn" onclick="changePeriod('month')">This Month</button>
            <button class="period-btn" onclick="changePeriod('week')">This Week</button>
            <button class="period-btn" onclick="changePeriod('day')">Today</button>
        </div>
        
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-value" id="total-trades">0</div>
                <div class="metric-label">Total Trades</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="win-rate">0%</div>
                <div class="metric-label">Win Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="winning-trades">0</div>
                <div class="metric-label">Winning Trades</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="total-pnl">$0</div>
                <div class="metric-label">Total P&L</div>
            </div>
        </div>
    </div>
    
    <!-- QUICK ACTIONS -->
    <div class="section">
        <div class="section-title">‚ö° Quick Actions</div>
        <div>
            <button class="btn btn-success" onclick="showAddTradeModal()">‚ûï Add Trade</button>
            <button class="btn" onclick="showCategoryManager()">üè∑Ô∏è Manage Categories</button>
            <button class="btn" onclick="location.reload()">üîÑ Refresh</button>
        </div>
    </div>
    
    <!-- CALENDAR -->
    <div class="section">
        <div class="section-title">üìÖ Trading Calendar</div>
        <div id="calendar"></div>
        <div style="color: #888; font-size: 0.9em; margin-top: 10px;">
            <span style="color: #4CAF50;">‚ñ†</span> Winning Day 
            <span style="color: #f44336; margin-left: 15px;">‚ñ†</span> Losing Day
        </div>
    </div>
    
    <!-- RECENT TRADES (5 ONLY) -->
    <div class="section">
        <div class="section-title">üîÑ Recent Trades</div>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Asset</th>
                    <th>Side</th>
                    <th>P&L</th>
                    <th>Key Level</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for trade in trades %}
                <tr>
                    <td>{{ trade.exit_time.split(' ')[0] if trade.exit_time else 'N/A' }}</td>
                    <td><strong>{{ trade.asset }}</strong></td>
                    <td><span style="color: {{ '#4CAF50' if trade.side == 'buy' else '#f44336' }}">{{ trade.side|upper }}</span></td>
                    <td class="{{ 'win' if trade.pnl > 0 else 'loss' }}">
                        <strong>${{ "%.2f"|format(trade.pnl) }}</strong>
                    </td>
                    <td>{{ trade.key_level or 'Not set' }}</td>
                    <td>
                        <button class="btn btn-small" onclick="editTrade({{ trade.id }})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteTrade({{ trade.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- STATISTICS -->
    <div class="section">
        <div class="section-title">üìä Statistics</div>
        
        <!-- FILTERS -->
        <div class="filters">
            <div class="filter-group">
                <label>Asset:</label>
                <select id="asset-filter" onchange="filterStats()">
                    <option value="ALL">All Assets</option>
                    {% for asset in assets %}
                    <option value="{{ asset }}">{{ asset }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label>Key Level Type:</label>
                <select id="type-filter" onchange="filterStats()">
                    <option value="ALL">All Types</option>
                    <option value="support">Support Only</option>
                    <option value="resistance">Resistance Only</option>
                </select>
            </div>
        </div>
        
        <!-- KEY LEVELS -->
        <div style="margin-bottom: 30px;">
            <h3 style="color: #FFC107; margin-bottom: 15px;">üéØ Key Levels</h3>
            <table>
                <thead>
                    <tr>
                        <th>Key Level</th>
                        <th style="text-align: center;">Win Rate</th>
                        <th style="text-align: center;">Total Trades</th>
                    </tr>
                </thead>
                <tbody id="key-levels-body">
                    {% for level, stats in key_levels_stats.items() %}
                    <tr>
                        <td>{{ level }}</td>
                        <td style="text-align: center; color: #4CAF50; font-weight: bold;">
                            {{ stats.win_rate }}%
                        </td>
                        <td style="text-align: center; color: #FFC107;">
                            {{ stats.wins }}/{{ stats.total }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- CONFIRMATIONS -->
        <div style="margin-bottom: 30px;">
            <h3 style="color: #FFC107; margin-bottom: 15px;">‚úÖ Confirmations</h3>
            <table>
                <thead>
                    <tr>
                        <th>Confirmation</th>
                        <th style="text-align: center;">Win Rate</th>
                        <th style="text-align: center;">Total Trades</th>
                    </tr>
                </thead>
                <tbody id="confirmations-body">
                    {% for confirmation, stats in confirmations_stats.items() %}
                    <tr>
                        <td>{{ confirmation }}</td>
                        <td style="text-align: center; color: #4CAF50; font-weight: bold;">
                            {{ stats.win_rate }}%
                        </td>
                        <td style="text-align: center; color: #FFC107;">
                            {{ stats.wins }}/{{ stats.total }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- MODELS -->
        <div>
            <h3 style="color: #FFC107; margin-bottom: 15px;">üîß Models</h3>
            <table>
                <thead>
                    <tr>
                        <th>Model</th>
                        <th style="text-align: center;">Win Rate</th>
                        <th style="text-align: center;">Total Trades</th>
                    </tr>
                </thead>
                <tbody id="models-body">
                    {% for model, stats in models_stats.items() %}
                    <tr>
                        <td>{{ model }}</td>
                        <td style="text-align: center; color: #4CAF50; font-weight: bold;">
                            {{ stats.win_rate }}%
                        </td>
                        <td style="text-align: center; color: #FFC107;">
                            {{ stats.wins }}/{{ stats.total }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ========== MODALS ========== -->
    
    <!-- ADD TRADE MODAL -->
    <div id="addTradeModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #FFC107; margin-bottom: 20px;">‚ûï Add New Trade</h2>
            <form onsubmit="addTrade(); return false;">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Asset *</label>
                        <select id="new-asset" required>
                            <option value="">Select asset...</option>
                            <option value="BTC">BTC</option>
                            <option value="ETH">ETH</option>
                            <option value="SOL">SOL</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Side *</label>
                        <select id="new-side" required>
                            <option value="">Select side...</option>
                            <option value="buy">Buy</option>
                            <option value="sell">Sell</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Entry Price *</label>
                        <input type="number" step="0.01" id="new-entry" placeholder="65000" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Exit Price *</label>
                        <input type="number" step="0.01" id="new-exit" placeholder="65200" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Quantity *</label>
                        <input type="number" step="0.001" id="new-quantity" placeholder="0.1" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Entry Time</label>
                        <input type="datetime-local" id="new-entry-time">
                    </div>
                    
                    <div class="form-group">
                        <label>Exit Time</label>
                        <input type="datetime-local" id="new-exit-time">
                    </div>
                </div>
                
                <h3 style="color: #FFC107; margin: 20px 0 15px 0;">Trade Analysis</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Key Level</label>
                        <input type="text" id="new-key-level" placeholder="e.g., 60k Resistance">
                    </div>
                    
                    <div class="form-group">
                        <label>Key Level Type</label>
                        <select id="new-key-level-type">
                            <option value="">Select type...</option>
                            <option value="support">Support</option>
                            <option value="resistance">Resistance</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Confirmation Method</label>
                        <input type="text" id="new-confirmation" placeholder="e.g., Volume Spike">
                    </div>
                    
                    <div class="form-group">
                        <label>Trading Model</label>
                        <input type="text" id="new-model" placeholder="e.g., Breakout">
                    </div>
                    
                    <div class="form-group">
                        <label>Screenshot URL</label>
                        <input type="text" id="new-screenshot" placeholder="https://example.com/screenshot.png">
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="new-notes" rows="2" placeholder="Additional notes..."></textarea>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Add Trade</button>
                    <button type="button" class="btn" onclick="closeModal('addTradeModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- DAY TRADES MODAL -->
    <div id="dayTradesModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #FFC107;" id="dayModalTitle">Trades for </h2>
                <button class="btn" onclick="closeModal('dayTradesModal')">√ó</button>
            </div>
            
            <div id="dayTradesContent"></div>
        </div>
    </div>
    
    <!-- EDIT TRADE MODAL -->
    <div id="editTradeModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #FFC107; margin-bottom: 20px;">‚úèÔ∏è Edit Trade</h2>
            <div id="editTradeContent"></div>
        </div>
    </div>
    
    <!-- CATEGORY MANAGER MODAL -->
    <div id="categoryManagerModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #FFC107; margin-bottom: 20px;">üè∑Ô∏è Category Manager</h2>
            <div id="categoryManagerContent"></div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // ========== CALENDAR ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Starting calendar...');
            
            try {
                // Get the JSON from Flask
                const jsonString = '{{ trades_by_date }}';
                let tradesByDate = {};
                
                if (jsonString && jsonString !== '{}') {
                    try {
                        tradesByDate = JSON.parse(jsonString);
                    } catch (e) {
                        console.error('JSON parse error:', e);
                        tradesByDate = {};
                    }
                }
                
                console.log('Calendar data:', Object.keys(tradesByDate).length, 'days');
                
                // If no data, use test data
                if (Object.keys(tradesByDate).length === 0) {
                    tradesByDate = {
                        '2025-12-15': {total_trades: 3, total_pnl: 150, wins: 2, losses: 1, trades: []},
                        '2025-12-20': {total_trades: 2, total_pnl: -50, wins: 1, losses: 1, trades: []},
                        '2025-12-25': {total_trades: 4, total_pnl: 320, wins: 3, losses: 1, trades: []}
                    };
                }
                
                const events = [];
                for (const date in tradesByDate) {
                    const stats = tradesByDate[date];
                    if (stats.total_trades > 0) {
                        // Color gradient based on P&L
                        let color;
                        if (stats.total_pnl > 0) {
                            const intensity = Math.min(0.7, stats.total_pnl / 1000);
                            color = `rgba(76, 175, 80, ${0.3 + intensity})`;
                        } else {
                            const intensity = Math.min(0.7, Math.abs(stats.total_pnl) / 1000);
                            color = `rgba(244, 67, 54, ${0.3 + intensity})`;
                        }
                        
                        events.push({
                            title: `${stats.total_trades}t | $${stats.total_pnl.toFixed(2)}`,
                            start: date,
                            backgroundColor: color,
                            borderColor: stats.total_pnl > 0 ? '#4CAF50' : '#f44336',
                            textColor: 'white',
                            extendedProps: {
                                date: date,
                                stats: stats,
                                tradeIds: stats.trades || []
                            }
                        });
                    }
                }
                
                const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                    initialView: 'dayGridMonth',
                    initialDate: '2025-12-01',
                    events: events,
                    eventClick: function(info) {
                        const date = info.event.extendedProps.date;
                        const stats = info.event.extendedProps.stats;
                        const tradeIds = info.event.extendedProps.tradeIds;
                        showDayTrades(date, stats, tradeIds);
                    },
                    height: 'auto'
                });
                
                calendar.render();
                console.log('‚úÖ Calendar loaded');
                
                // Initialize period stats
                updatePeriodStats('all');
                
                // Set default times in add trade form
                const now = new Date();
                const today = now.toISOString().slice(0, 16);
                document.getElementById('new-entry-time').value = today;
                document.getElementById('new-exit-time').value = today;
                
            } catch (error) {
                console.error('Calendar error:', error);
            }
        });
        
        // ========== DAY TRADES VIEW ==========
        function showDayTrades(date, stats, tradeIds) {
            document.getElementById('dayModalTitle').textContent = `Trades for ${date}`;
            
            let content = `
                <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div>
                            <div style="color: #888; font-size: 0.9em;">Total Trades</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #FFC107;">${stats.total_trades}</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.9em;">Daily P&L</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: ${stats.total_pnl >= 0 ? '#4CAF50' : '#f44336'}">
                                $${stats.total_pnl.toFixed(2)}
                            </div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.9em;">Win/Loss</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #FFC107;">${stats.wins}/${stats.losses}</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.9em;">Win Rate</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #4CAF50;">
                                ${stats.total_trades > 0 ? Math.round((stats.wins / stats.total_trades) * 100) : 0}%
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="addTradeForDate('${date}')">
                        + Add Trade for ${date}
                    </button>
                </div>
            `;
            
            if (tradeIds && tradeIds.length > 0) {
                // Fetch trade details
                fetch(`/api/day_trades/${date}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.trades.length > 0) {
                            data.trades.forEach(trade => {
                                content += `
                                    <div style="background: #2a2a2a; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid ${trade.pnl > 0 ? '#4CAF50' : '#f44336'}">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <div>
                                                <strong>${trade.asset} ${trade.side.toUpperCase()}</strong>
                                                <div style="color: #888; font-size: 0.9em;">
                                                    Entry: ${trade.entry_price} | Exit: ${trade.exit_price} | Qty: ${trade.quantity}
                                                </div>
                                            </div>
                                            <div class="${trade.pnl > 0 ? 'win' : 'loss'}" style="font-weight: bold;">
                                                $${trade.pnl.toFixed(2)}
                                            </div>
                                        </div>
                                        
                                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                                            <div>
                                                <small style="color: #888;">Key Level:</small><br>
                                                ${trade.key_level || 'Not set'}
                                            </div>
                                            <div>
                                                <small style="color: #888;">Confirmation:</small><br>
                                                ${trade.confirmation || 'Not set'}
                                            </div>
                                            <div>
                                                <small style="color: #888;">Model:</small><br>
                                                ${trade.model || 'Not set'}
                                            </div>
                                            <div>
                                                <small style="color: #888;">Type:</small><br>
                                                ${trade.key_level_type || 'Not set'}
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 10px;">
                                            <button class="btn btn-small" onclick="editTrade(${trade.id})">Edit Details</button>
                                            <button class="btn btn-small btn-danger" onclick="deleteTrade(${trade.id})">Delete</button>
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            content += `<p style="color: #888; text-align: center; padding: 20px;">No trades found for this date.</p>`;
                        }
                        
                        document.getElementById('dayTradesContent').innerHTML = content;
                        showModal('dayTradesModal');
                    });
            } else {
                content += `<p style="color: #888; text-align: center; padding: 40px;">No trades found for this date.</p>`;
                document.getElementById('dayTradesContent').innerHTML = content;
                showModal('dayTradesModal');
            }
        }
        
        function addTradeForDate(date) {
            closeModal('dayTradesModal');
            
            // Set the date in add trade modal
            document.getElementById('new-entry-time').value = `${date}T10:00`;
            document.getElementById('new-exit-time').value = `${date}T12:00`;
            
            showAddTradeModal();
        }
        
        // ========== PERIOD FILTERS ==========
        function changePeriod(period) {
            // Update button states
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updatePeriodStats(period);
        }
        
        function updatePeriodStats(period) {
            // Get stats from Flask template
            const stats = {
                'all': {{ all_stats|tojson|safe }},
                'month': {{ month_stats|tojson|safe }},
                'week': {{ week_stats|tojson|safe }},
                'day': {{ day_stats|tojson|safe }}
            };
            
            const periodStats = stats[period] || stats['all'];
            
            document.getElementById('total-trades').textContent = periodStats.total_trades;
            document.getElementById('win-rate').textContent = periodStats.win_rate + '%';
            document.getElementById('winning-trades').textContent = periodStats.winning_trades;
            
            const pnlElement = document.getElementById('total-pnl');
            pnlElement.textContent = '$' + periodStats.total_pnl;
            pnlElement.classList.toggle('negative', periodStats.total_pnl < 0);
        }
        
        // ========== TRADE MANAGEMENT ==========
        function showAddTradeModal() {
            showModal('addTradeModal');
        }
        
        function addTrade() {
            const data = {
                asset: document.getElementById('new-asset').value,
                side: document.getElementById('new-side').value,
                entry_price: parseFloat(document.getElementById('new-entry').value),
                exit_price: parseFloat(document.getElementById('new-exit').value),
                quantity: parseFloat(document.getElementById('new-quantity').value),
                entry_time: document.getElementById('new-entry-time').value || new Date().toISOString(),
                exit_time: document.getElementById('new-exit-time').value || new Date().toISOString(),
                key_level: document.getElementById('new-key-level').value,
                key_level_type: document.getElementById('new-key-level-type').value,
                confirmation: document.getElementById('new-confirmation').value,
                model: document.getElementById('new-model').value,
                screenshot: document.getElementById('new-screenshot').value,
                notes: document.getElementById('new-notes').value
            };
            
            fetch('/api/add_trade', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Success!', 'Trade added.', 'success');
                    closeModal('addTradeModal');
                    location.reload();
                }
            });
        }
        
        function editTrade(tradeId) {
            fetch(`/api/get_trade/${tradeId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const trade = data.trade;
                        
                        let html = `
                            <form onsubmit="saveTradeEdit(${tradeId}); return false;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Key Level</label>
                                        <input type="text" id="edit-key-level" value="${trade.key_level || ''}">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Key Level Type</label>
                                        <select id="edit-key-level-type">
                                            <option value="">Select type...</option>
                                            <option value="support" ${trade.key_level_type === 'support' ? 'selected' : ''}>Support</option>
                                            <option value="resistance" ${trade.key_level_type === 'resistance' ? 'selected' : ''}>Resistance</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Confirmation</label>
                                        <input type="text" id="edit-confirmation" value="${trade.confirmation || ''}">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Model</label>
                                        <input type="text" id="edit-model" value="${trade.model || ''}">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Screenshot URL</label>
                                        <input type="text" id="edit-screenshot" value="${trade.screenshot || ''}">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Notes</label>
                                        <textarea id="edit-notes" rows="3">${trade.notes || ''}</textarea>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 10px; margin-top: 20px;">
                                    <button type="submit" class="btn btn-success">Save Changes</button>
                                    <button type="button" class="btn" onclick="closeModal('editTradeModal')">Cancel</button>
                                </div>
                            </form>
                        `;
                        
                        document.getElementById('editTradeContent').innerHTML = html;
                        showModal('editTradeModal');
                    }
                });
        }
        
        function saveTradeEdit(tradeId) {
            const data = {
                key_level: document.getElementById('edit-key-level').value,
                key_level_type: document.getElementById('edit-key-level-type').value,
                confirmation: document.getElementById('edit-confirmation').value,
                model: document.getElementById('edit-model').value,
                screenshot: document.getElementById('edit-screenshot').value,
                notes: document.getElementById('edit-notes').value
            };
            
            fetch(`/api/update_trade/${tradeId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    Swal.fire('Success!', 'Trade updated.', 'success');
                    closeModal('editTradeModal');
                    location.reload();
                }
            });
        }
        
        function deleteTrade(tradeId) {
            Swal.fire({
                title: 'Delete Trade?',
                text: "This cannot be undone!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Delete'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/api/delete_trade/${tradeId}`, {method: 'DELETE'})
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('Deleted!', '', 'success');
                                location.reload();
                            }
                        });
                }
            });
        }
        
        // ========== CATEGORY MANAGEMENT ==========
        function showCategoryManager() {
            fetch('/api/get_categories')
                .then(r => r.json())
                .then(data => {
                    let html = '<div style="max-height: 400px; overflow-y: auto;">';
                    
                    // Key Levels
                    html += '<h4 style="color: #FFC107; margin-bottom: 10px;">üéØ Key Levels</h4>';
                    if (data.key_levels && data.key_levels.length > 0) {
                        data.key_levels.forEach(level => {
                            if (level) {
                                html += `
                                    <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333;">
                                        <span>${level}</span>
                                        <div>
                                            <button class="btn btn-small" onclick="renameCategory('key_level', '${level}')">Rename</button>
                                            <button class="btn btn-small btn-danger" onclick="deleteCategory('key_level', '${level}')">Delete</button>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                    }
                    
                    // Confirmations
                    html += '<h4 style="color: #FFC107; margin-top: 20px; margin-bottom: 10px;">‚úÖ Confirmations</h4>';
                    if (data.confirmations && data.confirmations.length > 0) {
                        data.confirmations.forEach(conf => {
                            if (conf) {
                                html += `
                                    <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333;">
                                        <span>${conf}</span>
                                        <div>
                                            <button class="btn btn-small" onclick="renameCategory('confirmation', '${conf}')">Rename</button>
                                            <button class="btn btn-small btn-danger" onclick="deleteCategory('confirmation', '${conf}')">Delete</button>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                    }
                    
                    // Models
                    html += '<h4 style="color: #FFC107; margin-top: 20px; margin-bottom: 10px;">üîß Models</h4>';
                    if (data.models && data.models.length > 0) {
                        data.models.forEach(model => {
                            if (model) {
                                html += `
                                    <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333;">
                                        <span>${model}</span>
                                        <div>
                                            <button class="btn btn-small" onclick="renameCategory('model', '${model}')">Rename</button>
                                            <button class="btn btn-small btn-danger" onclick="deleteCategory('model', '${model}')">Delete</button>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                    }
                    
                    html += '</div>';
                    
                    document.getElementById('categoryManagerContent').innerHTML = html;
                    showModal('categoryManagerModal');
                });
        }
        
        function renameCategory(type, oldName) {
            Swal.fire({
                title: `Rename ${type}`,
                input: 'text',
                inputValue: oldName,
                showCancelButton: true,
                confirmButtonText: 'Rename'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/api/update_category', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            type: type,
                            old_name: oldName,
                            new_name: result.value
                        })
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            showCategoryManager();
                        }
                    });
                }
            });
        }
        
        function deleteCategory(type, name) {
            Swal.fire({
                title: 'Delete Category?',
                text: "This will remove it from all trades!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Delete'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/api/delete_category', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({type: type, name: name})
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            showCategoryManager();
                        }
                    });
                }
            });
        }
        
        // ========== UTILITIES ==========
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function filterStats() {
            // Simple filter notification
            const asset = document.getElementById('asset-filter').value;
            const type = document.getElementById('type-filter').value;
            Swal.fire('Info', `Filtering by ${asset} and ${type}`, 'info');
        }
        
        // Initialize
        updatePeriodStats('all');
        
        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>