<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #111111;
            border: 1px solid #333333;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(180deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.02) 100%), #0b0b0b;
            color: white;
            padding: 15px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        .header h1 {
            font-size: 1.6em;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 0.85em;
            color: #9ca3af;
        }

        .period-filter {
            display: flex;
            justify-content: center;
            gap: 6px;
            padding: 8px 20px;
            background: #0b0b0b;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        .period-tab {
            padding: 6px 12px;
            border: 1px solid rgba(255,255,255,0.10);
            border-radius: 6px;
            background: rgba(255,255,255,0.03);
            color: #e5e7eb;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85em;
            transition: all 0.3s;
            user-select: none;
        }

        .period-tab:hover {
            border-color: rgba(139, 92, 246, 0.45);
        }

        .period-tab.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.18), rgba(139, 92, 246, 0.18));
            color: #ffffff;
            border-color: rgba(139, 92, 246, 0.75);
        }

        .metrics-dashboard {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            padding: 25px;
            background: #0b0b0b;
            border-bottom: 1px solid #333333;
        }

        .metric-card {
            background: #111111;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .chart-container {
            position: absolute;
            width: 130px;
            height: 70px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        .metric-label {
            font-size: 0.8em;
            color: #bbbbbb;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 1.6em;
            font-weight: bold;
            color: #ffffff;
            position: relative;
            z-index: 3;
        }

        .metric-value.positive {
            color: #00ff88;
        }

        .metric-value.negative {
            color: #ff3366;
        }

        .api-section {
            padding: 20px 25px;
            background: #0b0b0b;
            border-bottom: 1px solid #333333;
        }

        .api-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .api-status {
            font-weight: 600;
            padding: 8px 15px;
            border-radius: 20px;
            background: #111111;
            border: 1px solid #333333;
        }

        .api-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 1px solid #333333;
            border-radius: 8px;
            font-size: 0.95em;
            background: #111111;
            color: #ffffff;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .remember-me input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.18), rgba(139, 92, 246, 0.18));
            color: #ffffff;
            border: 1px solid rgba(139, 92, 246, 0.45);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(139, 92, 246, 0.25));
            border-color: rgba(139, 92, 246, 0.75);
        }

        .btn-success {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.18), rgba(139, 92, 246, 0.18));
            color: #ffffff;
            border: 1px solid rgba(139, 92, 246, 0.45);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(139, 92, 246, 0.25));
            border-color: rgba(139, 92, 246, 0.75);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            padding: 25px;
        }

        .calendar-section h2 { color: #ffffff; }

        .calendar-section {
            background: #111111;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #calendar {
            margin-top: 20px;
        }

        .fc-day-profit {
            background-color: rgba(0, 255, 136, 0.12) !important;
            border-radius: 10px;
        }

        .fc-day-loss {
            background-color: rgba(255, 51, 102, 0.12) !important;
            border-radius: 10px;
        }

        .fc .fc-scrollgrid,
        .fc .fc-scrollgrid-section > td,
        .fc .fc-daygrid-body,
        .fc .fc-toolbar .fc-button,
        .fc .fc-toolbar .fc-button:focus,
        .fc .fc-toolbar .fc-button:active,
        .fc .fc-toolbar .fc-button:focus-visible {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
            color: #ffffff !important;
        }

        .fc .fc-col-header-cell {
            background: #0b0b0b !important;
            border: none !important;
        }

        .fc-daygrid-day {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .day-stats {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -45%);
            text-align: center;
            font-size: 0.78em;
            color: #eaeaea;
            line-height: 1.15;
            pointer-events: none;
            width: calc(100% - 14px);
        }

        .day-pnl.positive {
            color: #8ff5c6;
        }

        .day-pnl.negative {
            color: #ff9db2;
        }

        .trades-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .trades-section {
            background: #111111;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .trades-section.open-trades {
            min-height: 350px;
        }

        .trades-section.closed-trades {
            margin-top: 20px;
        }

        .trades-section h3 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .trades-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .trades-list.open-list {
            max-height: 280px;
        }

        .trade-card {
            background: #0b0b0b;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #007bff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trade-card:hover {
            transform: translateX(5px);
        }

        .trade-card.profit {
            border-left-color: #00ff88;
        }

        .trade-card.loss {
            border-left-color: #ff3366;
        }

        .trade-card.open {
            border-left-color: #ffc107;
        }

        .trade-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .trade-asset {
            font-weight: bold;
            font-size: 0.95em;
        }

        .trade-pnl {
            font-weight: bold;
        }

        .trade-pnl.positive {
            color: #00ff88;
        }

        .trade-pnl.negative {
            color: #ff3366;
        }

        .trade-details {
            font-size: 0.8em;
            color: #bbbbbb;
        }

        .bias-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 5px;
        }

        .bias-badge.bullish {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .bias-badge.bearish {
            background: rgba(255, 51, 102, 0.2);
            color: #ff3366;
        }

        .bias-badge.neutral {
            background: rgba(255, 255, 255, 0.1);
            color: #bbbbbb;
        }

        .stats-section {
            padding: 25px;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
            padding: 15px;
            background: #0b0b0b;
            border-radius: 8px;
        }

        .stats-header h2 { color: #ffffff; }

        .stats-toggle {
            font-size: 1.5em;
            transition: transform 0.3s;
        }

        .stats-toggle.open {
            transform: rotate(180deg);
        }

        .stats-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .stats-content.open {
            max-height: 5000px;
        }

        .stats-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 0.85em;
            font-weight: 600;
            color: #bbbbbb;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.10);
            border-radius: 8px;
            background: #0b0b0b;
            color: #ffffff;
            color-scheme: dark;
            cursor: pointer;
        }

        .filter-select option {
            background: #0b0b0b;
            color: #ffffff;
            padding: 8px;
        }

        .filter-select:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.45);
            background: #0b0b0b;
        }

        .stat-box {
            background: #0b0b0b;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid rgba(255,255,255,0.10);
        }

        .stat-box.stat-keylevels { border-left-color: rgba(0, 255, 136, 0.85); }
        .stat-box.stat-confirmations { border-left-color: rgba(59, 130, 246, 0.85); }
        .stat-box.stat-models { border-left-color: rgba(255, 51, 102, 0.85); }

        .stat-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .stat-list {
            font-size: 0.95em;
            line-height: 1.8;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-name {
            font-weight: 500;
            flex: 1;
            color: #ffffff;
        }

        .stat-metrics {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .stat-count {
            background: #1a1a1a;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .stat-wr {
            font-size: 0.9em;
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }

        .stat-wr.good {
            color: #00ff88;
        }

        .stat-wr.average {
            color: #bbbbbb;
        }

        .stat-wr.poor {
            color: #ff3366;
        }

        .stat-bias-indicator {
            font-size: 0.75em;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 8px;
        }

        .stat-bias-indicator.with {
            background: rgba(0, 255, 136, 0.15);
            color: #00ff88;
        }

        .stat-bias-indicator.against {
            background: rgba(255, 51, 102, 0.15);
            color: #ff3366;
        }

        .pnl-chart-section {
            padding: 25px;
            background: #0b0b0b;
            border-bottom: 1px solid #333333;
        }

        .pnl-chart-container {
            background: #111111;
            border-radius: 12px;
            padding: 20px;
            height: 220px;
        }

        .pnl-chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
        }

        #customRange {
            display: none;
            justify-content: flex-start;
            gap: 10px;
            padding: 10px 0 0 0;
            flex-wrap: wrap;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #111111;
            border: 1px solid #333333;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #ffffff;
        }

        .modal-close {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.8em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #ff3366;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.9em;
            font-weight: 600;
            color: #bbbbbb;
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #333333;
            border-radius: 8px;
            background: #0b0b0b;
            color: #ffffff;
            font-size: 0.95em;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-select {
            cursor: pointer;
            color-scheme: dark;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.45);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .metrics-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ImbAlance Trading Journal</h1>
            <p>Performance Statistics</p>
        </div>

        <div class="metrics-dashboard" id="metricsDashboard">
            <div class="metric-card">
                <div class="metric-label">Win Rate</div>
                <div class="metric-value" id="winRateValue">0%</div>
                <div class="chart-container">
                    <canvas id="winRateChart"></canvas>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total P&L</div>
                <div class="metric-value" id="totalPnl">$0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Trades</div>
                <div class="metric-value" id="totalTrades">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Win</div>
                <div class="metric-value positive" id="avgWin">$0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Loss</div>
                <div class="metric-value negative" id="avgLoss">$0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Profit Factor</div>
                <div class="metric-value" id="profitFactor">0.00</div>
            </div>
        </div>

        <div class="pnl-chart-section">
            <div class="period-filter">
                <div class="period-tab active" data-period="all" onclick="changePeriod('all')">All Time</div>
                <div class="period-tab" data-period="month" onclick="changePeriod('month')">This Month</div>
                <div class="period-tab" data-period="week" onclick="changePeriod('week')">This Week</div>
                <div class="period-tab" data-period="today" onclick="changePeriod('today')">Today</div>
                <div class="period-tab" data-period="custom" onclick="changePeriod('custom')">Custom</div>
            </div>
            <div id="customRange">
                <input type="date" id="customStart" class="api-input" style="max-width: 170px;" />
                <input type="date" id="customEnd" class="api-input" style="max-width: 170px;" />
                <button class="btn btn-primary" style="padding: 8px 14px;" onclick="applyCustomRange()">Apply</button>
            </div>
            <div class="pnl-chart-container">
                <div class="pnl-chart-title">Cumulative P&L Over Time</div>
                <canvas id="pnlChart" style="height: 180px;"></canvas>
            </div>
        </div>

        <div class="api-section">
            <div class="api-container">
                <div class="api-status" id="apiStatus">Not Connected</div>
                <input type="text" class="api-input" id="apiKey" placeholder="Bybit API Key">
                <input type="password" class="api-input" id="apiSecret" placeholder="API Secret">
                <select class="api-input" id="bybitNetwork" style="max-width: 160px;">
                    <option value="mainnet">Mainnet</option>
                    <option value="testnet">Testnet</option>
                </select>
                <label class="remember-me">
                    <input type="checkbox" id="rememberMe">
                    <span>Remember Me</span>
                </label>
                <button class="btn btn-primary" onclick="saveApiCredentials()">Save</button>
                <button class="btn btn-success" onclick="syncBybitTrades()">Sync Trades</button>
                <button class="btn btn-secondary" onclick="cleanDuplicates()">Clean Duplicates</button>
            </div>
        </div>

        <div class="main-content">
            <div class="calendar-section">
                <h2>Trading Calendar</h2>
                <div id="calendar"></div>
            </div>

            <div class="trades-container">
                <div class="trades-section open-trades">
                    <h3>Open Trades</h3>
                    <div class="trades-list open-list" id="openTradesList"></div>
                </div>

                <div class="trades-section closed-trades">
                    <h3>Recent Closed Trades</h3>
                    <div class="trades-list" id="closedTradesList"></div>
                </div>
            </div>
        </div>

        <div class="stats-section">
            <div class="stats-header" onclick="toggleStats()">
                <h2>Performance Statistics</h2>
                <span class="stats-toggle" id="statsToggle">▼</span>
            </div>
            <div class="stats-content" id="statsContent">
                <div class="stats-filters">
                    <div class="filter-group">
                        <span class="filter-label">Asset</span>
                        <select class="filter-select" id="assetFilter" onchange="updateStatsFilter()">
                            <option value="all">All Assets</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Bias W</span>
                        <select class="filter-select" id="weeklyBiasFilter" onchange="updateStatsFilter()">
                            <option value="all">All</option>
                            <option value="bullish">Bullish</option>
                            <option value="bearish">Bearish</option>
                            <option value="neutral">Neutral</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Bias D</span>
                        <select class="filter-select" id="dailyBiasFilter" onchange="updateStatsFilter()">
                            <option value="all">All</option>
                            <option value="bullish">Bullish</option>
                            <option value="bearish">Bearish</option>
                            <option value="neutral">Neutral</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Side</span>
                        <select class="filter-select" id="sideFilter" onchange="updateStatsFilter()">
                            <option value="all">All</option>
                            <option value="long">Long</option>
                            <option value="short">Short</option>
                        </select>
                    </div>
                </div>

                <div class="stat-box stat-keylevels">
                    <div class="stat-title">Key Levels Performance</div>
                    <div class="stat-list" id="keyLevelsStats"></div>
                </div>

                <div class="stat-box stat-confirmations">
                    <div class="stat-title">Confirmations Performance</div>
                    <div class="stat-list" id="confirmationsStats"></div>
                </div>

                <div class="stat-box stat-models">
                    <div class="stat-title">Models Performance</div>
                    <div class="stat-list" id="modelsStats"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Trade Modal -->
    <div class="modal-overlay" id="editTradeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Trade</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editTradeForm" onsubmit="saveTradeEdit(event)">
                <input type="hidden" id="editTradeId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Asset</label>
                        <input type="text" class="form-input" id="editAsset" required readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Side</label>
                        <select class="form-select" id="editSide" required disabled>
                            <option value="long">Long</option>
                            <option value="short">Short</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Weekly Bias</label>
                        <select class="form-select" id="editWeeklyBias" required>
                            <option value="bullish">Bullish</option>
                            <option value="bearish">Bearish</option>
                            <option value="neutral">Neutral</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Daily Bias</label>
                        <select class="form-select" id="editDailyBias" required>
                            <option value="bullish">Bullish</option>
                            <option value="bearish">Bearish</option>
                            <option value="neutral">Neutral</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Key Level</label>
                    <input type="text" class="form-input" id="editKeyLevel" placeholder="e.g., 50000">
                </div>

                <div class="form-group">
                    <label class="form-label">Key Level Type</label>
                    <input type="text" class="form-input" id="editKeyLevelType" placeholder="e.g., Support, Resistance, FVG">
                </div>

                <div class="form-group">
                    <label class="form-label">Confirmation</label>
                    <input type="text" class="form-input" id="editConfirmation" placeholder="e.g., Breakout, Retest, Volume">
                </div>

                <div class="form-group">
                    <label class="form-label">Model</label>
                    <input type="text" class="form-input" id="editModel" placeholder="e.g., Power of 3, AMD, ICT">
                </div>

                <div class="form-group">
                    <label class="form-label">Screenshot URL</label>
                    <input type="url" class="form-input" id="editScreenshot" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="editNotes" placeholder="Add your trade notes..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let calendar;
        let currentPeriod = 'all';
        let customStartDate = '';
        let customEndDate = '';
        let statsOpen = false;
        let calendarDates = {};
        let allTrades = [];
        let pnlChart = null;
        let statsFilter = {
            weeklyBias: 'all',
            dailyBias: 'all',
            asset: 'all',
            side: 'all'
        };

        document.addEventListener('DOMContentLoaded', function() {
            initCalendar();
            loadTrades();
            loadOpenTrades();
            loadApiCredentials();
        });

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: ''
                },
                dayCellDidMount: function(info) {
                    const dateStr = info.date.toISOString().split('T')[0];
                    if (calendarDates[dateStr]) {
                        const dayData = calendarDates[dateStr];
                        
                        if (dayData.pnl > 0) {
                            info.el.classList.add('fc-day-profit');
                        } else if (dayData.pnl < 0) {
                            info.el.classList.add('fc-day-loss');
                        }
                        
                        const statsDiv = document.createElement('div');
                        statsDiv.className = 'day-stats';
                        statsDiv.innerHTML = `
                            <div class="day-trades">${dayData.count} trade${dayData.count > 1 ? 's' : ''}</div>
                            <div class="day-pnl ${dayData.pnl >= 0 ? 'positive' : 'negative'}">${dayData.pnl >= 0 ? '+' : ''}${dayData.pnl.toFixed(0)}</div>
                            <div class="day-wr">${dayData.winRate.toFixed(0)}% WR</div>
                        `;
                        info.el.appendChild(statsDiv);
                    }
                },
                dateClick: function(info) {
                    showDayTrades(info.dateStr);
                }
            });
            calendar.render();
            loadCalendarData();
        }

        async function loadCalendarData() {
            try {
                const response = await fetch('/api/calendar_data');
                const events = await response.json();
                
                calendarDates = {};
                events.forEach(event => {
                    calendarDates[event.start] = {
                        pnl: event.extendedProps.pnl,
                        count: event.extendedProps.trade_count,
                        winRate: event.extendedProps.win_rate
                    };
                });
                
                calendar.render();
            } catch (error) {
                console.error('Error loading calendar:', error);
                alert('Error loading calendar data');
            }
        }

        function toggleStats() {
            statsOpen = !statsOpen;
            const content = document.getElementById('statsContent');
            const toggle = document.getElementById('statsToggle');
            
            if (statsOpen) {
                content.classList.add('open');
                toggle.classList.add('open');
            } else {
                content.classList.remove('open');
                toggle.classList.remove('open');
            }
        }

        function changePeriod(period) {
            currentPeriod = period;

            const customRange = document.getElementById('customRange');
            if (customRange) {
                customRange.style.display = period === 'custom' ? 'flex' : 'none';
            }
            
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');

            if (period !== 'custom') {
                customStartDate = '';
                customEndDate = '';
                loadTrades();
            }
        }

        function applyCustomRange() {
            const start = document.getElementById('customStart')?.value || '';
            const end = document.getElementById('customEnd')?.value || '';

            if (!start || !end) {
                alert('Please select both dates');
                return;
            }

            customStartDate = start;
            customEndDate = end;
            loadTrades();
        }

        async function loadTrades() {
            try {
                let url = `/api/trades?period=${currentPeriod}&status=closed`;
                if (currentPeriod === 'custom' && customStartDate && customEndDate) {
                    url += `&start_date=${customStartDate}&end_date=${customEndDate}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                allTrades = data.trades;
                
                updateMetrics(data.statistics);
                displayClosedTrades(data.trades.slice(0, 10));
                populateAssetFilter(data.trades);
                updateStatsFilter();
                updatePnlChart(data.trades);
                
            } catch (error) {
                console.error('Error loading trades:', error);
                alert('Error loading trades');
            }
        }

        async function loadOpenTrades() {
            try {
                const response = await fetch('/api/trades?status=open');
                const data = await response.json();
                displayOpenTrades(data.trades);
            } catch (error) {
                console.error('Error loading open trades:', error);
            }
        }

        function populateAssetFilter(trades) {
            const assets = [...new Set(trades.map(t => t.asset))].sort();
            const assetFilter = document.getElementById('assetFilter');
            const currentValue = assetFilter.value;
            
            assetFilter.innerHTML = '<option value="all">All Assets</option>' + 
                assets.map(asset => `<option value="${asset}">${asset}</option>`).join('');
            
            if (assets.includes(currentValue)) {
                assetFilter.value = currentValue;
            }
        }

        function updateMetrics(stats) {
            document.getElementById('totalPnl').textContent = '$' + stats.total_pnl.toFixed(2);
            document.getElementById('totalPnl').className = 'metric-value ' + (stats.total_pnl >= 0 ? 'positive' : 'negative');
            
            document.getElementById('totalTrades').textContent = stats.total_trades;
            document.getElementById('avgWin').textContent = '$' + stats.avg_win.toFixed(2);
            document.getElementById('avgLoss').textContent = '$' + stats.avg_loss.toFixed(2);
            document.getElementById('profitFactor').textContent = stats.profit_factor.toFixed(2);
            
            updateWinRateChart(stats.win_rate);
        }

        let winRateChart = null;

        function updateWinRateChart(winRate) {
            const ctx = document.getElementById('winRateChart').getContext('2d');
            const winRateValue = document.getElementById('winRateValue');
            
            winRateValue.textContent = winRate + '%';
            
            let color;
            if (winRate >= 60) color = '#00ff88';
            else if (winRate >= 50) color = '#3b82f6';
            else if (winRate >= 40) color = '#f59e0b';
            else color = '#ff3366';
            
            if (winRateChart) {
                winRateChart.destroy();
            }
            
            winRateChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [winRate, 100 - winRate],
                        backgroundColor: [color, 'rgba(255, 255, 255, 0.05)'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '88%',
                    rotation: -90,
                    circumference: 180,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }

        function displayOpenTrades(trades) {
            const container = document.getElementById('openTradesList');
            if (trades.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #bbbbbb; padding: 20px;">No open trades</p>';
                return;
            }
            
            container.innerHTML = trades.map(trade => {
                const currentPnl = trade.side === 'long' 
                    ? (trade.entry_price * trade.quantity * 0.02)
                    : -(trade.entry_price * trade.quantity * 0.02);
                
                return `
                    <div class="trade-card open" onclick="editTrade(${trade.id})">
                        <div class="trade-header">
                            <span class="trade-asset">
                                ${trade.asset} ${trade.side.toUpperCase()}
                                <span class="bias-badge ${trade.weekly_bias}">${trade.weekly_bias[0].toUpperCase()}</span>
                                <span class="bias-badge ${trade.daily_bias}">${trade.daily_bias[0].toUpperCase()}</span>
                            </span>
                            <span class="trade-pnl ${currentPnl >= 0 ? 'positive' : 'negative'}">
                                ${currentPnl >= 0 ? '+' : ''}$${currentPnl.toFixed(2)}
                            </span>
                        </div>
                        <div class="trade-details">
                            Entry: $${trade.entry_price} • Qty: ${trade.quantity}<br>
                            ${new Date(trade.entry_time).toLocaleString()}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayClosedTrades(trades) {
            const container = document.getElementById('closedTradesList');
            if (trades.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #bbbbbb; padding: 20px;">No trades for this period</p>';
                return;
            }
            
            container.innerHTML = trades.map(trade => `
                <div class="trade-card ${(trade.pnl || 0) > 0 ? 'profit' : 'loss'}" onclick="editTrade(${trade.id})">
                    <div class="trade-header">
                        <span class="trade-asset">
                            ${trade.asset} ${trade.side.toUpperCase()}
                            <span class="bias-badge ${trade.weekly_bias}">${trade.weekly_bias[0].toUpperCase()}</span>
                            <span class="bias-badge ${trade.daily_bias}">${trade.daily_bias[0].toUpperCase()}</span>
                        </span>
                        <span class="trade-pnl ${(trade.pnl || 0) >= 0 ? 'positive' : 'negative'}">
                            ${(trade.pnl || 0) >= 0 ? '+' : ''}$${(trade.pnl || 0).toFixed(2)}
                        </span>
                    </div>
                    <div class="trade-details">
                        ${new Date(trade.entry_time).toLocaleDateString()} • 
                        Entry: $${trade.entry_price} → Exit: $${trade.exit_price || 0}
                    </div>
                </div>
            `).join('');
        }

        async function showDayTrades(dateStr) {
            try {
                const response = await fetch(`/api/trades_by_date?date=${dateStr}`);
                const data = await response.json();
                
                if (data.trades.length === 0) {
                    alert('No trades on this day');
                    return;
                }

                displayClosedTrades(data.trades);
                document.querySelector('.closed-trades').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading day trades:', error);
                alert('Error loading trades for this day');
            }
        }

        async function editTrade(tradeId) {
            try {
                const response = await fetch(`/api/trades/${tradeId}`);
                const trade = await response.json();
                
                document.getElementById('editTradeId').value = trade.id;
                document.getElementById('editAsset').value = trade.asset;
                document.getElementById('editSide').value = trade.side;
                document.getElementById('editWeeklyBias').value = trade.weekly_bias || 'neutral';
                document.getElementById('editDailyBias').value = trade.daily_bias || 'neutral';
                document.getElementById('editKeyLevel').value = trade.key_level || '';
                document.getElementById('editKeyLevelType').value = trade.key_level_type || '';
                document.getElementById('editConfirmation').value = trade.confirmation || '';
                document.getElementById('editModel').value = trade.model || '';
                document.getElementById('editScreenshot').value = trade.screenshot_url || '';
                document.getElementById('editNotes').value = trade.notes || '';
                
                document.getElementById('editTradeModal').classList.add('active');
            } catch (error) {
                console.error('Error loading trade:', error);
                alert('Error loading trade details');
            }
        }

        function closeEditModal() {
            document.getElementById('editTradeModal').classList.remove('active');
        }

        async function saveTradeEdit(event) {
            event.preventDefault();
            
            const tradeId = document.getElementById('editTradeId').value;
            
            try {
                const originalResponse = await fetch(`/api/trades/${tradeId}`);
                const originalTrade = await originalResponse.json();
                
                const updatedTrade = {
                    ...originalTrade,
                    weekly_bias: document.getElementById('editWeeklyBias').value,
                    daily_bias: document.getElementById('editDailyBias').value,
                    key_level: document.getElementById('editKeyLevel').value,
                    key_level_type: document.getElementById('editKeyLevelType').value,
                    confirmation: document.getElementById('editConfirmation').value,
                    model: document.getElementById('editModel').value,
                    screenshot_url: document.getElementById('editScreenshot').value,
                    notes: document.getElementById('editNotes').value
                };
                
                const response = await fetch(`/api/trades/${tradeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedTrade)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeEditModal();
                    loadTrades();
                    loadOpenTrades();
                    loadCalendarData();
                    alert('Trade updated successfully!');
                } else {
                    alert('Error updating trade');
                }
            } catch (error) {
                console.error('Error saving trade:', error);
                alert('Error saving trade changes');
            }
        }

        function updateStatsFilter() {
            statsFilter.weeklyBias = document.getElementById('weeklyBiasFilter').value;
            statsFilter.dailyBias = document.getElementById('dailyBiasFilter').value;
            statsFilter.asset = document.getElementById('assetFilter').value;
            statsFilter.side = document.getElementById('sideFilter').value;

            let filteredTrades = allTrades;

            if (statsFilter.asset !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.asset === statsFilter.asset);
            }

            if (statsFilter.side !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.side.toLowerCase() === statsFilter.side);
            }

            if (statsFilter.weeklyBias !== 'all') {
                filteredTrades = filteredTrades.filter(t => {
                    const weekly = (t.weekly_bias || 'neutral').toLowerCase();
                    return weekly === statsFilter.weeklyBias;
                });
            }

            if (statsFilter.dailyBias !== 'all') {
                filteredTrades = filteredTrades.filter(t => {
                    const daily = (t.daily_bias || 'neutral').toLowerCase();
                    return daily === statsFilter.dailyBias;
                });
            }

            const keyLevelStats = calculatePerformanceStats(filteredTrades, 'key_level_type');
            document.getElementById('keyLevelsStats').innerHTML = formatPerformanceStats(keyLevelStats);
            
            const confirmationStats = calculatePerformanceStats(filteredTrades, 'confirmation');
            document.getElementById('confirmationsStats').innerHTML = formatPerformanceStats(confirmationStats);
            
            const modelStats = calculatePerformanceStats(filteredTrades, 'model');
            document.getElementById('modelsStats').innerHTML = formatPerformanceStats(modelStats);
        }

        function calculatePerformanceStats(trades, field) {
            const stats = {};
            
            trades.forEach(trade => {
                const key = trade[field];
                if (!key || key === '') return;
                
                if (!stats[key]) {
                    stats[key] = {
                        total: 0,
                        wins: 0,
                        with_bias: 0,
                        with_wins: 0,
                        against_bias: 0,
                        against_wins: 0
                    };
                }
                
                stats[key].total++;
                
                const pnl = trade.pnl || 0;
                if (pnl > 0) {
                    stats[key].wins++;
                }

                const weekly = (trade.weekly_bias || 'neutral').toLowerCase();
                const side = trade.side.toLowerCase();

                const withWeekly = (weekly === 'bullish' && side === 'long') || 
                                  (weekly === 'bearish' && side === 'short');
                const againstWeekly = (weekly === 'bullish' && side === 'short') || 
                                     (weekly === 'bearish' && side === 'long');

                if (withWeekly) {
                    stats[key].with_bias++;
                    if (pnl > 0) stats[key].with_wins++;
                } else if (againstWeekly) {
                    stats[key].against_bias++;
                    if (pnl > 0) stats[key].against_wins++;
                }
            });
            
            Object.keys(stats).forEach(key => {
                const s = stats[key];
                s.winRate = s.total > 0 ? (s.wins / s.total * 100).toFixed(1) : 0;
                s.withWinRate = s.with_bias > 0 ? (s.with_wins / s.with_bias * 100).toFixed(1) : null;
                s.againstWinRate = s.against_bias > 0 ? (s.against_wins / s.against_bias * 100).toFixed(1) : null;
            });
            
            return stats;
        }

        function formatPerformanceStats(stats) {
            const entries = Object.entries(stats);
            
            if (entries.length === 0) {
                return '<p style="color: #bbbbbb; text-align: center; padding: 20px;">No data for current filters</p>';
            }
            
            entries.sort((a, b) => parseFloat(b[1].winRate) - parseFloat(a[1].winRate));
            
            return entries.map(([key, data]) => {
                const wrClass = data.winRate >= 60 ? 'good' : data.winRate >= 50 ? 'average' : 'poor';
                const displayName = key.replace(/_/g, ' ');
                
                let biasInfo = '';
                if (data.withWinRate !== null) {
                    biasInfo += `<span class="stat-bias-indicator with" title="WITH bias">WITH ${data.withWinRate}% (${data.with_bias})</span>`;
                }
                if (data.againstWinRate !== null) {
                    biasInfo += `<span class="stat-bias-indicator against" title="AGAINST bias">VS ${data.againstWinRate}% (${data.against_bias})</span>`;
                }
                
                return `
                    <div class="stat-item">
                        <span class="stat-name">${displayName}</span>
                        <div class="stat-metrics">
                            <span class="stat-count">${data.total}</span>
                            <span class="stat-wr ${wrClass}">${data.winRate}%</span>
                            ${biasInfo}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadApiCredentials() {
            try {
                const response = await fetch('/api/get_bybit_credentials');
                const data = await response.json();
                
                if (data.connected) {
                    document.getElementById('apiKey').value = data.api_key;
                    document.getElementById('apiSecret').value = data.api_secret;
                    document.getElementById('rememberMe').checked = data.remember_me;
                    document.getElementById('bybitNetwork').value = data.network;
                    document.getElementById('apiStatus').textContent = 'Connected';
                    document.getElementById('apiStatus').style.borderColor = '#28a745';
                } else {
                    document.getElementById('apiStatus').textContent = 'Not Connected';
                    document.getElementById('apiStatus').style.borderColor = '#dc3545';
                }
            } catch (error) {
                console.error('Error loading credentials:', error);
            }
        }

        async function saveApiCredentials() {
            const data = {
                api_key: document.getElementById('apiKey').value,
                api_secret: document.getElementById('apiSecret').value,
                network: document.getElementById('bybitNetwork').value,
                remember_me: document.getElementById('rememberMe').checked
            };

            try {
                const response = await fetch('/api/save_bybit_credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    alert('API credentials saved!');
                    document.getElementById('apiStatus').textContent = 'Connected';
                    document.getElementById('apiStatus').style.borderColor = '#28a745';
                }
            } catch (error) {
                console.error('Error saving credentials:', error);
                alert('Error saving credentials');
            }
        }

        async function syncBybitTrades() {
            if (!confirm('Sync trades from Bybit? This may take a moment.')) return;

            try {
                const response = await fetch('/api/sync_bybit_trades', { method: 'POST' });
                const result = await response.json();

                alert(result.message);
                if (result.success && result.trades_synced > 0) {
                    loadTrades();
                    loadCalendarData();
                }
            } catch (error) {
                console.error('Error syncing trades:', error);
                alert('Sync error. Check console.');
            }
        }

        async function cleanDuplicates() {
            if (!confirm('Remove all duplicate trades? This will keep only the first occurrence of each trade.')) return;

            try {
                const response = await fetch('/api/clean_duplicates', { method: 'POST' });
                const result = await response.json();

                alert(result.message);
                if (result.success) {
                    loadTrades();
                    loadOpenTrades();
                    loadCalendarData();
                }
            } catch (error) {
                console.error('Error cleaning duplicates:', error);
                alert('Error cleaning duplicates.');
            }
        }

        function updatePnlChart(trades) {
            const canvas = document.getElementById('pnlChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            const sorted = [...trades].sort((a, b) => new Date(a.entry_time) - new Date(b.entry_time));

            const labels = [];
            const series = [];
            let runningTotal = 0;

            sorted.forEach(trade => {
                runningTotal += trade.pnl || 0;
                labels.push(new Date(trade.entry_time).toLocaleDateString());
                series.push(runningTotal);
            });

            const lineColor = runningTotal >= 0 ? '#00ff88' : '#ff3366';

            if (!pnlChart) {
                pnlChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            data: series,
                            borderColor: lineColor,
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0,
                            tension: 0.35
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `Cumulative: $${ctx.parsed.y.toFixed(2)}`
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: '#aaa', maxRotation: 0, autoSkip: true }
                            },
                            y: {
                                grid: { display: false },
                                ticks: {
                                    color: '#aaa',
                                    callback: (val) => `$${Number(val).toFixed(0)}`
                                }
                            }
                        }
                    }
                });
            } else {
                pnlChart.data.labels = labels;
                pnlChart.data.datasets[0].data = series;
                pnlChart.data.datasets[0].borderColor = lineColor;
                pnlChart.update();
            }
        }
    </script>
</body>
</html>