<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TradeZilla Simple</title>
    <style>
        body { 
            background: #0f172a; 
            color: white; 
            font-family: Arial; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
        }
        .logo { 
            font-size: 24px; 
            font-weight: bold; 
            color: #3b82f6; 
        }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .card { 
            background: #1e293b; 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #334155; 
            text-align: center; 
        }
        .card-value { 
            font-size: 32px; 
            font-weight: bold; 
            margin: 10px 0; 
        }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .widgets { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .widget { 
            background: #1e293b; 
            border-radius: 10px; 
            border: 1px solid #334155; 
            padding: 20px; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
        }
        th, td { 
            padding: 10px; 
            text-align: left; 
            border-bottom: 1px solid #334155; 
        }
        th { 
            background: #0f172a; 
            color: #94a3b8; 
        }
        .calendar { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 5px; 
            margin-top: 10px; 
        }
        .calendar-day { 
            aspect-ratio: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 5px; 
            border: 1px solid #334155; 
            font-size: 12px; 
            cursor: pointer; 
        }
        .calendar-day.has-data { 
            border-color: #3b82f6; 
        }
        .calendar-day.profit { 
            background: rgba(16, 185, 129, 0.2); 
        }
        .calendar-day.loss { 
            background: rgba(239, 68, 68, 0.2); 
        }
        .btn { 
            padding: 8px 16px; 
            background: #3b82f6; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        .btn:hover { 
            background: #2563eb; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ðŸ’° TradeZilla Simple</div>
            <button class="btn" onclick="refresh()">Refresh</button>
        </div>
        
        <div class="stats">
            <div class="card">
                <div>Total P&L</div>
                <div class="card-value positive" id="total-pnl">$0.00</div>
            </div>
            <div class="card">
                <div>Win Rate</div>
                <div class="card-value" id="win-rate">0%</div>
            </div>
            <div class="card">
                <div>Total Trades</div>
                <div class="card-value" id="total-trades">0</div>
            </div>
            <div class="card">
                <div>Avg Trade</div>
                <div class="card-value" id="avg-trade">$0.00</div>
            </div>
        </div>
        
        <div class="widgets">
            <div class="widget">
                <h3>ðŸ“Š Recent Trades</h3>
                <table id="recent-trades">
                    <thead>
                        <tr>
                            <th>Instrument</th>
                            <th>Side</th>
                            <th>P&L</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="widget">
                <h3>ðŸŽ¯ Key Levels</h3>
                <table id="key-levels">
                    <thead>
                        <tr>
                            <th>Instrument</th>
                            <th>Level</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="widget">
                <h3>ðŸ“… Calendar</h3>
                <div id="calendar"></div>
            </div>
            
            <div class="widget">
                <h3>ðŸ“ˆ By Instrument</h3>
                <table id="instruments">
                    <thead>
                        <tr>
                            <th>Instrument</th>
                            <th>Trades</th>
                            <th>P&L</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        async function loadDashboard() {
            try {
                console.log('Loading dashboard...');
                
                // Load stats
                const statsRes = await fetch('/api/dashboard-stats');
                const statsData = await statsRes.json();
                console.log('Stats loaded:', statsData);
                
                // Update stats
                document.getElementById('total-pnl').textContent = 
                    '$' + (statsData.overall.total_pnl || 0).toFixed(2);
                document.getElementById('total-pnl').className = 
                    `card-value ${(statsData.overall.total_pnl || 0) >= 0 ? 'positive' : 'negative'}`;
                
                document.getElementById('win-rate').textContent = 
                    statsData.win_rate.toFixed(1) + '%';
                
                document.getElementById('total-trades').textContent = 
                    statsData.overall.total_trades || 0;
                
                document.getElementById('avg-trade').textContent = 
                    '$' + (statsData.overall.avg_pnl || 0).toFixed(2);
                
                // Update recent trades
                const tradesBody = document.querySelector('#recent-trades tbody');
                tradesBody.innerHTML = '';
                statsData.recent_trades.forEach(trade => {
                    const row = `<tr>
                        <td>${trade.instrument}</td>
                        <td>${trade.direction}</td>
                        <td class="${trade.pnl >= 0 ? 'positive' : 'negative'}">
                            $${trade.pnl.toFixed(2)}
                        </td>
                    </tr>`;
                    tradesBody.innerHTML += row;
                });
                
                // Update key levels
                const levelsBody = document.querySelector('#key-levels tbody');
                levelsBody.innerHTML = '';
                statsData.key_levels.forEach(level => {
                    const row = `<tr>
                        <td>${level.instrument}</td>
                        <td>${level.level_name}</td>
                        <td>$${level.level_price}</td>
                    </tr>`;
                    levelsBody.innerHTML += row;
                });
                
                // Update instruments
                const instBody = document.querySelector('#instruments tbody');
                instBody.innerHTML = '';
                statsData.instruments.forEach(inst => {
                    const row = `<tr>
                        <td>${inst.instrument}</td>
                        <td>${inst.trades}</td>
                        <td class="${inst.total_pnl >= 0 ? 'positive' : 'negative'}">
                            $${inst.total_pnl.toFixed(2)}
                        </td>
                    </tr>`;
                    instBody.innerHTML += row;
                });
                
                // Load calendar
                await loadCalendar();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading data: ' + error.message);
            }
        }
        
        async function loadCalendar() {
            try {
                const res = await fetch('/api/analytics/calendar/current');
                const data = await res.json();
                
                const calendarDiv = document.getElementById('calendar');
                calendarDiv.innerHTML = '';
                
                // Day headers
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                days.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.textContent = day;
                    dayEl.style.textAlign = 'center';
                    dayEl.style.color = '#94a3b8';
                    calendarDiv.appendChild(dayEl);
                });
                
                // Empty cells for days before the first day
                for (let i = 0; i < data.first_weekday; i++) {
                    const empty = document.createElement('div');
                    calendarDiv.appendChild(empty);
                }
                
                // Days of the month
                for (let day = 1; day <= data.days_in_month; day++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = day;
                    
                    const dayData = data.data[day];
                    if (dayData) {
                        dayEl.classList.add('has-data');
                        dayEl.classList.add(dayData.pnl >= 0 ? 'profit' : 'loss');
                        dayEl.title = `$${dayData.pnl.toFixed(2)} - ${dayData.trades} trades`;
                    }
                    
                    calendarDiv.appendChild(dayEl);
                }
                
            } catch (error) {
                console.error('Error loading calendar:', error);
            }
        }
        
        function refresh() {
            loadDashboard();
        }
        
        // Load on page load
        window.onload = loadDashboard;
        
        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>